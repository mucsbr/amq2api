<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Amazon Q 账号管理控制台</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#0f1420;
      --muted:#8b95a8;
      --text:#e8f0ff;
      --accent:#4f8fff;
      --danger:#ff4757;
      --ok:#2ed573;
      --warn:#ffa502;
      --border:#1a2332;
      --chip:#141b28;
      --code:#0d1218;
      --glow:rgba(79,143,255,.15);
    }
    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; }
    body {
      padding:0 0 40px;
      background:radial-gradient(ellipse at top, #0f1624 0%, #0a0e1a 100%);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Noto Sans,Arial,sans-serif;
      line-height:1.6;
    }
    h1,h2,h3 { font-weight:700; letter-spacing:-.02em; margin:0; }
    h1 { font-size:28px; margin:24px 0 12px; background:linear-gradient(135deg,#4f8fff,#7b9fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    h2 { font-size:18px; margin:20px 0 16px; color:#c5d4ff; }
    h3 { font-size:15px; margin:16px 0 10px; color:#a8b8d8; }
    .container { max-width:1280px; margin:0 auto; padding:20px; }
    .panel {
      background:linear-gradient(145deg,rgba(15,20,32,.8),rgba(10,14,26,.9));
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px;
      box-shadow:0 20px 60px rgba(0,0,0,.4),0 0 0 1px rgba(79,143,255,.08),inset 0 1px 0 rgba(255,255,255,.03);
      backdrop-filter:blur(12px);
      transition:transform .2s,box-shadow .2s;
      margin-bottom:20px;
    }
    .panel:hover { transform:translateY(-2px); box-shadow:0 24px 70px rgba(0,0,0,.5),0 0 0 1px rgba(79,143,255,.12),inset 0 1px 0 rgba(255,255,255,.04); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { color:var(--muted); font-size:13px; font-weight:500; letter-spacing:.01em; }
    .field { display:flex; flex-direction:column; gap:8px; flex:1; min-width:200px; }
    input,textarea,select {
      background:rgba(12,16,28,.6);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      outline:none;
      transition:all .2s;
      font-size:14px;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.2);
    }
    input:focus,textarea:focus,select:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--glow),inset 0 1px 2px rgba(0,0,0,.2);
      background:rgba(12,16,28,.8);
    }
    textarea { min-height:140px; resize:vertical; font-family:ui-monospace,monospace; }
    button {
      background:linear-gradient(135deg,#2563eb,#1e40af);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:12px 20px;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      transition:all .2s;
      box-shadow:0 4px 16px rgba(37,99,235,.3),inset 0 1px 0 rgba(255,255,255,.1);
      position:relative;
      overflow:hidden;
    }
    button:before {
      content:'';
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,rgba(255,255,255,.1),transparent);
      opacity:0;
      transition:opacity .2s;
    }
    button:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(37,99,235,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    button:hover:before { opacity:1; }
    button:active { transform:translateY(0); }
    button:disabled { opacity:.5; cursor:not-allowed; transform:none; }
    .btn-secondary { background:linear-gradient(135deg,#1e293b,#0f172a); box-shadow:0 4px 16px rgba(15,23,42,.3),inset 0 1px 0 rgba(255,255,255,.05); }
    .btn-secondary:hover { box-shadow:0 6px 20px rgba(15,23,42,.4),inset 0 1px 0 rgba(255,255,255,.08); }
    .btn-danger { background:linear-gradient(135deg,#dc2626,#991b1b); box-shadow:0 4px 16px rgba(220,38,38,.3),inset 0 1px 0 rgba(255,255,255,.1); }
    .btn-danger:hover { box-shadow:0 6px 20px rgba(220,38,38,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    .btn-warn { background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 4px 16px rgba(245,158,11,.3),inset 0 1px 0 rgba(255,255,255,.1); }
    .btn-warn:hover { box-shadow:0 6px 20px rgba(245,158,11,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    .kvs { display:grid; grid-template-columns:160px 1fr; gap:10px 16px; font-size:13px; }
    .muted { color:var(--muted); }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:rgba(20,27,40,.8);
      border:1px solid var(--border);
      border-radius:20px;
      color:#a8b8ff;
      font-size:12px;
      font-weight:500;
      box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    .list { display:flex; flex-direction:column; gap:12px; max-height:600px; overflow:auto; padding:2px; }
    .list::-webkit-scrollbar { width:8px; }
    .list::-webkit-scrollbar-track { background:rgba(0,0,0,.2); border-radius:4px; }
    .list::-webkit-scrollbar-thumb { background:rgba(79,143,255,.3); border-radius:4px; }
    .list::-webkit-scrollbar-thumb:hover { background:rgba(79,143,255,.5); }
    .card {
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      background:linear-gradient(145deg,rgba(12,19,34,.6),rgba(10,14,26,.8));
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.02);
      transition:all .2s;
    }
    .card:hover { border-color:rgba(79,143,255,.3); box-shadow:0 6px 20px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.03); }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .right { margin-left:auto; }
    .sep { height:1px; background:linear-gradient(90deg,transparent,rgba(79,143,255,.2),transparent); margin:16px 0; }
    .status-ok { color:var(--ok); font-weight:600; }
    .status-fail { color:var(--danger); font-weight:600; }
    .switch { position:relative; display:inline-block; width:50px; height:26px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider {
      position:absolute;
      cursor:pointer;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,#374151,#1f2937);
      transition:.3s;
      border-radius:26px;
      border:1px solid var(--border);
      box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
    }
    .slider:before {
      position:absolute;
      content:"";
      height:20px;
      width:20px;
      left:3px;
      bottom:2px;
      background:linear-gradient(135deg,#f3f4f6,#e5e7eb);
      transition:.3s;
      border-radius:50%;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
    }
    input:checked+.slider { background:linear-gradient(135deg,#3b82f6,#2563eb); box-shadow:0 0 12px rgba(59,130,246,.4),inset 0 2px 4px rgba(0,0,0,.2); }
    input:checked+.slider:before { transform:translateX(24px); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .panel { animation:fadeIn .4s ease-out; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Amazon Q 账号管理控制台</h1>

    <div class="panel">
      <h2>系统状态</h2>
      <div class="row">
        <div class="field" style="max-width:300px">
          <label>健康检查</label>
          <div class="row">
            <button class="btn-secondary" onclick="checkHealth()">检查</button>
            <div id="health" class="chip">未检测</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>账号管理</h2>
      <div class="row">
        <button class="btn-secondary" onclick="loadAccounts()">刷新列表</button>
        <button class="btn-warn" onclick="testAllAccounts()">测试所有启用账号</button>
        <input id="test_message" placeholder="测试消息" value="Hello" style="max-width:200px" />
        <div id="test_status" class="chip" style="display:none"></div>
      </div>
      <div id="test_results" style="margin-top:12px"></div>
      <div class="list" id="accounts"></div>

      <div class="sep"></div>

      <h3>创建账号</h3>
      <div class="row">
        <div class="field"><label>label</label><input id="new_label" /></div>
        <div class="field"><label>clientId</label><input id="new_clientId" /></div>
        <div class="field"><label>clientSecret</label><input id="new_clientSecret" /></div>
      </div>
      <div class="row">
        <div class="field"><label>refreshToken</label><input id="new_refreshToken" /></div>
        <div class="field"><label>accessToken (可选)</label><input id="new_accessToken" /></div>
      </div>
      <div class="row">
        <div class="field" style="max-width:220px">
          <label>启用（仅启用账号会被用于请求）</label>
          <div>
            <label class="switch">
              <input id="new_enabled" type="checkbox" checked />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
      <div class="row">
        <button onclick="createAccount()">创建</button>
      </div>

      <div class="sep"></div>

      <h3>批量导入账号（测试）</h3>
      <div class="field">
        <label>账号数据（每行一个，格式：email|password|clientId|clientSecret|refreshToken|accessToken）</label>
        <textarea id="import_data" placeholder="user@example.com|pass123|client_id_xxx|client_secret_xxx|refresh_token_xxx|access_token_xxx"></textarea>
      </div>
      <div class="row">
        <button onclick="importAccounts()">批量导入</button>
        <button class="btn-secondary" onclick="exportAccounts()">导出所有账号</button>
        <div id="import_status" class="chip" style="display:none"></div>
      </div>

    </div>
  </div>

<script>
function setHealth(text, ok=true) {
  const el = document.getElementById('health');
  el.textContent = text;
  el.style.color = ok ? 'var(--ok)' : 'var(--danger)';
}

async function checkHealth(){
  try{
    const r = await fetch('/health');
    const j = await r.json();
    if (j && j.status === 'healthy') {
      setHealth(`健康 (${j.enabled_accounts} 个启用账号)`, true);
    } else {
      setHealth('不健康', false);
    }
  } catch(e){
    setHealth('错误', false);
  }
}

function renderAccounts(list){
  const root = document.getElementById('accounts');
  root.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '暂无账号';
    root.appendChild(empty);
    return;
  }
  for (const acc of list) {
    const card = document.createElement('div');
    card.className = 'card';

    const header = document.createElement('div');
    header.className = 'row';
    const name = document.createElement('div');
    name.innerHTML = '<strong>' + (acc.label || '(无标签)') + '</strong>';
    const id = document.createElement('div');
    id.className = 'chip mono';
    id.textContent = acc.id;

    const spacer = document.createElement('div');
    spacer.className = 'right';

    // Enabled toggle
    const toggleWrap = document.createElement('div');
    const toggleLabel = document.createElement('label');
    toggleLabel.style.marginRight = '6px';
    toggleLabel.className = 'muted';
    toggleLabel.textContent = '启用';
    const toggle = document.createElement('label');
    toggle.className = 'switch';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = !!acc.enabled;
    chk.onchange = async () => {
      try {
        await updateAccount(acc.id, { enabled: chk.checked });
      } catch(e) {
        chk.checked = !chk.checked;
      }
    };
    const slider = document.createElement('span');
    slider.className = 'slider';
    toggle.appendChild(chk); toggle.appendChild(slider);
    toggleWrap.appendChild(toggleLabel); toggleWrap.appendChild(toggle);

    const testBtn = document.createElement('button');
    testBtn.className = 'btn-secondary';
    testBtn.textContent = '测试';
    testBtn.onclick = () => testSingleAccount(acc.id);

    const refreshBtn = document.createElement('button');
    refreshBtn.className = 'btn-warn';
    refreshBtn.textContent = '刷新Token';
    refreshBtn.onclick = () => refreshAccount(acc.id);

    const delBtn = document.createElement('button');
    delBtn.className = 'btn-danger';
    delBtn.textContent = '删除';
    delBtn.onclick = () => deleteAccount(acc.id);

    header.appendChild(name);
    header.appendChild(id);
    header.appendChild(spacer);
    header.appendChild(toggleWrap);
    header.appendChild(testBtn);
    header.appendChild(refreshBtn);
    header.appendChild(delBtn);
    card.appendChild(header);

    const meta = document.createElement('div');
    meta.className = 'kvs mono';
    function row(k, v, style) {
      const kEl = document.createElement('div'); kEl.className = 'muted'; kEl.textContent = k;
      const vEl = document.createElement('div'); vEl.textContent = v ?? '';
      if (style) vEl.style.cssText = style;
      meta.appendChild(kEl); meta.appendChild(vEl);
    }

    // 检查是否被封
    const other = acc.other || {};
    const isSuspended = other.suspended === true;

    row('enabled', String(!!acc.enabled));
    if (isSuspended) {
      row('状态', '⚠️ 账号已被封禁', 'color:var(--danger);font-weight:600');
      row('封禁时间', other.suspended_at || 'N/A');
      row('封禁原因', other.suspend_reason || 'N/A');
    }
    row('last_refresh_status', acc.last_refresh_status);
    row('last_refresh_time', acc.last_refresh_time);
    row('clientId', acc.clientId);
    row('hasRefreshToken', acc.refreshToken ? 'yes' : 'no');
    row('hasAccessToken', acc.accessToken ? 'yes' : 'no');
    row('created_at', acc.created_at);
    row('updated_at', acc.updated_at);
    card.appendChild(meta);

    // quick edit form (label, accessToken)
    const editRow = document.createElement('div');
    editRow.className = 'row';
    editRow.style.marginTop = '8px';
    const labelField = document.createElement('input');
    labelField.placeholder = 'label';
    labelField.value = acc.label || '';
    const accessField = document.createElement('input');
    accessField.placeholder = 'accessToken（可选）';
    accessField.value = acc.accessToken || '';
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-secondary';
    saveBtn.textContent = '保存';
    saveBtn.onclick = async () => {
      await updateAccount(acc.id, { label: labelField.value, accessToken: accessField.value });
    };
    editRow.appendChild(labelField);
    editRow.appendChild(accessField);
    editRow.appendChild(saveBtn);
    card.appendChild(editRow);

    root.appendChild(card);
  }
}

async function loadAccounts(){
  try{
    const r = await fetch('/v2/accounts');
    const j = await r.json();
    renderAccounts(j);
  } catch(e){
    alert('加载账户失败：' + e);
  }
}

async function createAccount(){
  const body = {
    label: document.getElementById('new_label').value.trim() || null,
    clientId: document.getElementById('new_clientId').value.trim(),
    clientSecret: document.getElementById('new_clientSecret').value.trim(),
    refreshToken: document.getElementById('new_refreshToken').value.trim() || null,
    accessToken: document.getElementById('new_accessToken').value.trim() || null,
    enabled: document.getElementById('new_enabled').checked
  };
  try{
    const r = await fetch('/v2/accounts', {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      const t = await r.text();
      throw new Error(t);
    }
    await loadAccounts();
    // 清空表单
    document.getElementById('new_label').value = '';
    document.getElementById('new_clientId').value = '';
    document.getElementById('new_clientSecret').value = '';
    document.getElementById('new_refreshToken').value = '';
    document.getElementById('new_accessToken').value = '';
  } catch(e){
    alert('创建失败：' + e);
  }
}

async function deleteAccount(id){
  if (!confirm('确认删除该账号？')) return;
  try{
    const r = await fetch('/v2/accounts/' + encodeURIComponent(id), { method:'DELETE' });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('删除失败：' + e);
  }
}

async function updateAccount(id, patch){
  try{
    const r = await fetch('/v2/accounts/' + encodeURIComponent(id), {
      method:'PATCH',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(patch)
    });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('更新失败：' + e);
  }
}

async function refreshAccount(id){
  try{
    const r = await fetch('/v2/accounts/' + encodeURIComponent(id) + '/refresh', { method:'POST' });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('刷新失败：' + e);
  }
}

function setImportStatus(text, ok=true){
  const el = document.getElementById('import_status');
  el.textContent = text;
  el.style.color = ok ? 'var(--ok)' : 'var(--danger)';
  el.style.display = 'inline-flex';
}

async function importAccounts(){
  const data = document.getElementById('import_data').value.trim();
  if (!data) {
    alert('请输入账号数据');
    return;
  }

  const lines = data.split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
  if (lines.length === 0) {
    alert('没有有效的账号数据');
    return;
  }

  setImportStatus(`准备导入 ${lines.length} 个账号...`, true);

  let success = 0, failed = 0;
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    const parts = line.split('|').map(p => p.trim());

    if (parts.length !== 6) {
      setImportStatus(`第 ${i+1} 行格式错误（需要6个字段）`, false);
      failed++;
      continue;
    }

    const [email, password, clientId, clientSecret, refreshToken, accessToken] = parts;

    try {
      const r = await fetch('/v2/accounts', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({
          label: email,
          clientId,
          clientSecret,
          refreshToken: refreshToken || null,
          accessToken: accessToken || null,
          enabled: true
        })
      });

      if (r.ok) {
        success++;
        setImportStatus(`导入中... ${success}/${lines.length} 成功`, true);
      } else {
        failed++;
        setImportStatus(`导入中... ${success} 成功, ${failed} 失败`, false);
      }
    } catch(e) {
      failed++;
      setImportStatus(`导入中... ${success} 成功, ${failed} 失败`, false);
    }
  }

  setImportStatus(`导入完成: ${success} 成功, ${failed} 失败`, failed === 0);
  await loadAccounts();

  if (failed === 0) {
    document.getElementById('import_data').value = '';
  }
}

function setTestStatus(text, ok=true){
  const el = document.getElementById('test_status');
  el.textContent = text;
  el.style.color = ok ? 'var(--ok)' : 'var(--danger)';
  el.style.display = 'inline-flex';
}

async function exportAccounts(){
  try {
    const r = await fetch('/v2/accounts');
    const accounts = await r.json();

    if (accounts.length === 0) {
      alert('没有账号可导出');
      return;
    }

    const lines = accounts.map(acc =>
      `${acc.label || acc.clientId}|password|${acc.clientId}|${acc.clientSecret}|${acc.refreshToken || ''}|${acc.accessToken || ''}`
    );

    const content = lines.join('\n');
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `accounts_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  } catch(e) {
    alert('导出失败：' + e);
  }
}

async function testSingleAccount(accountId){
  const msg = document.getElementById('test_message').value.trim() || 'Hello';
  const accounts = await (await fetch('/v2/accounts')).json();
  const acc = accounts.find(a => a.id === accountId);

  if (!acc) {
    alert('账号不存在');
    return;
  }

  setTestStatus(`测试账号 ${acc.label}...`, true);
  document.getElementById('test_results').innerHTML = '';

  try {
    const r = await fetch('/v1/messages', {
      method: 'POST',
      headers: {
        'content-type': 'application/json',
        'X-Account-ID': accountId
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4',
        max_tokens: 50,
        messages: [{ role: 'user', content: msg }]
      })
    });

    if (!r.ok) {
      const errText = await r.text();
      setTestStatus(`测试失败`, false);
      document.getElementById('test_results').innerHTML = `<div class="card"><div><strong style="color:var(--danger)">✗ ${acc.label}</strong></div><div style="font-size:12px;color:var(--danger);margin-top:8px">${errText}</div></div>`;
      return;
    }

    const reader = r.body.getReader();
    const decoder = new TextDecoder();
    let text = '';

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;
          try {
            const json = JSON.parse(data);
            if (json.type === 'content_block_delta' && json.delta?.text) {
              text += json.delta.text;
            }
          } catch(e) {}
        }
      }
    }

    setTestStatus(`测试成功`, true);
    document.getElementById('test_results').innerHTML = `<div class="card"><div><strong style="color:var(--ok)">✓ ${acc.label}</strong></div><div class="mono" style="font-size:12px;margin-top:8px">${text}</div></div>`;
  } catch(e) {
    setTestStatus(`测试失败`, false);
    document.getElementById('test_results').innerHTML = `<div class="card"><div><strong style="color:var(--danger)">✗ ${acc.label}</strong></div><div style="font-size:12px;color:var(--danger);margin-top:8px">${e}</div></div>`;
  }
}

async function testAllAccounts(){
  const msg = document.getElementById('test_message').value.trim() || 'Hello';
  const accounts = await (await fetch('/v2/accounts')).json();
  const enabled = accounts.filter(a => a.enabled);

  if (enabled.length === 0) {
    alert('没有启用的账号');
    return;
  }

  setTestStatus(`测试 ${enabled.length} 个账号...`, true);
  document.getElementById('test_results').innerHTML = '';

  let success = 0, failed = 0;
  const results = [];

  for (const acc of enabled) {
    try {
      const r = await fetch('/v1/messages', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4',
          max_tokens: 50,
          messages: [{ role: 'user', content: msg }]
        })
      });

      if (!r.ok) {
        failed++;
        results.push(`<div class="card"><div><strong style="color:var(--danger)">✗ ${acc.label}</strong></div><div style="font-size:12px;color:var(--danger);margin-top:8px">${await r.text()}</div></div>`);
        setTestStatus(`测试中... ${success+failed}/${enabled.length}`, true);
        continue;
      }

      const reader = r.body.getReader();
      const decoder = new TextDecoder();
      let text = '';

      while (true) {
        const {done, value} = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = line.slice(6);
            if (data === '[DONE]') continue;
            try {
              const json = JSON.parse(data);
              if (json.type === 'content_block_delta' && json.delta?.text) {
                text += json.delta.text;
              }
            } catch(e) {}
          }
        }
      }

      success++;
      results.push(`<div class="card"><div><strong style="color:var(--ok)">✓ ${acc.label}</strong></div><div class="mono" style="font-size:12px;margin-top:8px">${text.substring(0,100)}${text.length > 100 ? '...' : ''}</div></div>`);
      setTestStatus(`测试中... ${success+failed}/${enabled.length}`, true);
    } catch(e) {
      failed++;
      results.push(`<div class="card"><div><strong style="color:var(--danger)">✗ ${acc.label}</strong></div><div style="font-size:12px;color:var(--danger);margin-top:8px">${e}</div></div>`);
    }
  }

  setTestStatus(`完成: ${success} 成功, ${failed} 失败`, failed === 0);
  document.getElementById('test_results').innerHTML = results.join('');
}

window.addEventListener('DOMContentLoaded', () => {
  loadAccounts();
});
</script>
</body>
</html>